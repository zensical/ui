////
/// Copyright (c) 2025 Zensical and contributors
///
/// SPDX-License-Identifier: MIT
/// Third-party contributions licensed under DCO
///
/// Permission is hereby granted, free of charge, to any person obtaining a
/// copy of this software and associated documentation files (the "Software"),
/// to deal in the Software without restriction, including without limitation
/// the rights to use, copy, modify, merge, publish, distribute, sublicense,
/// and/or sell copies of the Software, and to permit persons to whom the
/// Software is furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in
/// all copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL
/// THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
/// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
/// DEALINGS
////

// ----------------------------------------------------------------------------
// Rules
// ----------------------------------------------------------------------------

// Navigation variables
:root {
  --md-nav-icon--next: svg-load("lucide/chevron-right.svg");
}

// ----------------------------------------------------------------------------

// Navigation
.md-nav {
  font-size: px2rem(14px);
  line-height: 1.3;
  transition: max-height 250ms cubic-bezier(0.86, 0, 0.07, 1);

  // Navigation title - we don't need the navigation title in the modern
  // theme, as the navigation layout was greatly simplified
  .md-nav__title {
    display: none;
  }

  // Navigation list
  &__list {
    display: flex;
    flex-direction: column;
    gap: px2rem(4px);
    padding: 0;
    margin: 0;
    list-style: none;

    // Adjust spacing for level 2+
    & & {
      margin-inline-start: px2rem(12px);
    }
  }

  // Navigation item
  &__item {

    // Navigation list in nested item
    &--nested .md-nav__list {

      // Adjust spacing before nested list for better outlines
      &::before,
      &::after {
        display: block;
        height: 0;
        content: " ";
      }
    }
  }

  // Navigation link
  &__link {
    display: flex;
    gap: px2rem(12px);
    align-items: flex-start;
    padding: px2rem(7px) px2rem(16px);
    margin-inline: px2rem(4px);
    cursor: pointer;
    border-radius: px2rem(8px);
    transition:
      color            250ms,
      background-color 250ms;

    // Remove margin on nested navigation link - this is essentially necessary
    // for section index pages, as they use two nested elements
    & & {
      margin: 0;
    }

    // Navigation link that was passed
    &--passed {

      // Also enable color transitions on inline code blocks
      &,
      code {
        color: var(--md-default-fg-color--light);
      }
    }

    // Active link
    .md-nav__item &--active {
      font-weight: 500;

      // Only use background in primary navigation
      .md-nav--primary & {
        color: var(--md-accent-fg-color);
        background: var(--md-accent-fg-color--transparent);
      }

      // Also enable color transitions on inline code blocks
      &,
      code {
        color: var(--md-typeset-a-color);

        // Navigation link icon
        svg {
          opacity: 1;
        }
      }
    }

    // Navigation link in nested item
    .md-nav__item--nested > &:not(.md-nav__container) {
      padding-inline-end: px2rem(7px);
    }

    // Navigation link title
    .md-ellipsis {
      // Hack: Safari exhibits a bug where the text will sometimes disappear
      // and the element will become unclickable. Setting `position: relative`
      // seems to fix the issue - see https://bit.ly/3HljM1T
      position: relative;
      flex-grow: 1;

      // Truncate overflowing code blocks in the navigation with ellipsis, as
      // the full link title is always shown as a tooltip on focus/hover
      code {
        word-break: normal;
      }
    }

    // Navigation link icon
    svg {
      // Hack: Safari has another bug where SVGs disappear on hover - same fix
      // as above via `position: relative` - see https://t.ly/5fSj1
      position: relative;
      flex-shrink: 0;
      width: 1.3em;
      height: 1.3em;
      opacity: 0.5;
      fill: currentcolor;

      // Override for Lucide icons, which use strokes
      &.lucide {
        fill: transparent;
        stroke: currentcolor;
      }
    }

    // Styles for primary navigation
    .md-nav--primary & {

      // Navigation link on focus/hover
      &:is([href], [for]):is(:focus, :hover):not(.md-nav__link--active) {
        color: var(--md-default-fg-color);
        background-color: var(--md-default-fg-color--lightest);
      }
    }

    // Styles for primary navigation
    .md-nav--secondary & {
      padding: px2rem(7px) px2rem(16px);
      margin-inline: px2rem(4px);

      // Navigation link on focus/hover
      &:is([href], [for]):is(:focus, :hover) {
        color: var(--md-accent-fg-color);
        background-color: transparent;
      }
    }

    // Show outline for keyboard devices
    &.focus-visible {
      outline-color: var(--md-accent-fg-color);
    }

    // Navigation link for table of contents
    .md-nav--primary &[for="__toc"] {
      display: none;

      // Hide table of contents
      ~ .md-nav {
        display: none;
      }
    }
  }

  // Navigation icon
  &__icon {
    width: px2rem(18px);
    height: px2rem(18px);
    font-size: px2rem(18px);

    // Adjust for right-to-left languages
    [dir="rtl"] &::after {
      transform: rotate(180deg);
    }

    // Navigation icon in link to next level
    .md-nav__item--nested &::after {
      display: block;
      width: 100%;
      height: 100%;
      content: "";
      background-color: currentcolor;
      mask-image: var(--md-nav-icon--next);
      mask-repeat: no-repeat;
      mask-position: center;
      mask-size: contain;
      transition: transform 250ms;
    }

    // Hide icon when marked as section on larger screens
    @include break-from-device(screen) {
      .md-nav__item--nested.md-nav__item--section > .md-nav__link &::after {
        display: none;
      }
    }

    // Navigation icon - rotate icon when toggle is active or indeterminate
    .md-nav__item--nested .md-nav__toggle:checked ~ .md-nav__link &::after,
    .md-nav__item--nested .md-toggle--indeterminate ~ .md-nav__link &::after {
      transform: rotate(90deg);
    }
  }

  // Navigation container (for section index pages)
  &__container {
    gap: px2rem(4px);
    padding: 0;
    background: transparent;

    // Stretch first child
    > :first-child {
      flex-grow: 1;
      // Hack: if a very long word is used, it can push the arrow out of sight.
      // Setting this property contains the text - see https://t.ly/E02vp
      min-width: 0;
    }

    // Adjust spacing for icon
    > :nth-child(2) {
      padding: px2rem(7px);

      // Hide icon when marked as section
      @include break-from-device(screen) {
        .md-nav__item--section > & {
          display: none;
        }
      }
    }

    // Navigation icon
    &__icon {
      flex-shrink: 0;
    }
  }

  // Hide nested navigation
  &__toggle ~ & {
    display: grid;
    // Hack: we must set a minimum of 8px to work around a bug introduced in
    // Safari 18.3, collapsing to a height of 0 â€“ see https://t.ly/ViA3N
    grid-template-rows: minmax(#{px2rem(0.1px)}, 0fr);
    visibility: collapse;
    opacity: 0;
    transition:
      grid-template-rows 250ms cubic-bezier(0.86, 0, 0.07, 1),
      opacity            250ms,
      visibility           0ms 250ms;

    // Navigation list
    > .md-nav__list {
      overflow: hidden;
    }
  }

  // Show nested navigation when toggle is active or indeterminate
  &__toggle:is(:checked, .md-toggle--indeterminate) ~ & {
    grid-template-rows: minmax(#{px2rem(8px)}, 1fr);
    visibility: visible;
    opacity: 1;
    transition:
      grid-template-rows 250ms cubic-bezier(0.86, 0, 0.07, 1),
      opacity            150ms 100ms,
      visibility           0ms;
  }

  // Disable transition for expanded navigation
  &__toggle.md-toggle--indeterminate ~ & {
    transition: none;
  }

  // Table of contents
  &--secondary {
    margin-block: px2rem(2px);

    // Adjust spacing
    .md-nav {
      margin-top: px2rem(4px);

      // Navigation title
      &__title {
        position: sticky;
        top: 0;
        // Hack: because of the hack that we need to make .md-ellipsis work in
        // Safari, we need to set `z-index` here as - see https://bit.ly/3s5M2jm
        z-index: 1;
        display: flex;
        padding: px2rem(7px) px2rem(12px);
        margin-inline: px2rem(4px);
        font-weight: 700;
        background: var(--md-default-bg-color);

        // Hide navigation icon
        .md-nav__icon {
          display: none;
        }
      }

      // Navigation link
      &__link {
        padding: px2rem(4px) px2rem(12px);
      }
    }
  }

  // [tablet landscape -]: Mobile navigation
  @include break-to-device(tablet landscape) {

    // Primary navigation
    &--primary {
      margin-inline: px2rem(4px);
      margin-bottom: px2rem(8px);
    }

    // Navigation title - we don't need the navigation title in the modern
    // theme, as the navigation layout was greatly simplified
    .md-nav__title[for="__drawer"] {
      display: flex;
      gap: px2rem(8px);
      align-items: center;
      padding: px2rem(16px);
      font-size: px2rem(16px);
      font-weight: 700;
      border-bottom: px2rem(1px) solid var(--md-default-fg-color-lightest);

      // Logo
      .md-logo {
        width: px2rem(32px);
        height: px2rem(32px);

        // Image or icon
        :is(img, svg) {
          display: block;
          width: auto;
          max-width: 100%;
          height: 100%;
          object-fit: contain;
          fill: currentcolor;

          // Override for Lucide icons, which use strokes
          &.lucide {
            fill: transparent;
            stroke: currentcolor;
          }
        }
      }
    }
  }

  // Repository information container
  &__source {
    border-radius: px2rem(8px);
    border: px2rem(1px) solid var(--md-default-fg-color--lightest);
    margin: px2rem(4px);
    margin-bottom: px2rem(12px);
    transition:
      250ms background-color,
      250ms border-color;

    // Link on focus/hover
    &:is(:focus, :hover) {
      background-color: var(--md-default-fg-color--lightest);
      border-color: transparent;
    }
  }

  // Modifier for when table of contents is rendered in primary navigation
  &--integrated > .md-nav__list > .md-nav__item--active {

    // Show integrated table of contents
    .md-nav--secondary {
      display: block;
      margin-inline-start: px2rem(22px);
      margin-block: 0.5em;
      visibility: visible;
      border-inline-start: px2rem(1px) solid var(--md-default-fg-color--lightest);
      opacity: 1;

      // Navigation link
      .md-nav__link {
        background: transparent;

        // Active link in table of contents
        &--active {
          font-weight: 500;
        }

        // Navigation link on focus/hover
        &:is(:focus, :hover) {
          color: var(--md-accent-fg-color);
        }
      }

      // Navigation list
      > .md-nav__list {
        padding-bottom: 0;
        margin-left: 0;
        overflow: visible;
      }

      // Hide table of contents title
      > .md-nav__title {
        display: none;
      }
    }
  }

  // [screen +]: Tree-like navigation
  @include break-from-device(screen) {

    // Primary navigation
    &--primary {
      margin-block: px2rem(2px);
    }

    // Repository information container
    &__source {
      display: none;
    }

    // Adjust spacing for sections
    &__list .md-nav__item--section > .md-nav > &__list {
      margin-inline-start: 0;
    }

    // Navigation link
    &__link {

      // Active link in navigation section
      .md-nav__item--section > &--active,
      .md-nav__item--section > & > &--active {
        font-weight: 700;
      }
    }

    // Navigation section
    &__item--section {
      margin-top: px2rem(8px);

      // Adjust spacing on first child
      &:first-child {
        margin-top: 0;
      }

      // Adjust spacing on last child
      &:last-child {
        margin-bottom: 0;
      }

      // Show navigation link as title
      > .md-nav__link {
        font-weight: 700;

        // Omit clicks if not a section index page
        &:not(.md-nav__container) {
          pointer-events: none;
        }
      }

      // Navigation
      > .md-nav {
        display: block;
        visibility: visible;
        opacity: 1;

        // Adjust spacing on next level item
        > .md-nav__list > .md-nav__item {
          padding: 0;
        }
      }
    }

    // Modifier for when navigation tabs are rendered
    &--lifted {
      margin-top: 0;

      // Hide level 0 navigation items
      > .md-nav__list > .md-nav__item {
        display: none;

        // Active parent navigation item
        &--active {
          display: block;

          // Apply spacing for outlines
          > .md-nav {
            margin-top: px2rem(2px);

            // Remove gap
            > .md-nav__list::before {
              display: none;
            }
          }

          // Show navigation link as title
          > .md-nav__link {
            display: none;
          }

          // Adjust spacing for navigation section
          &.md-nav__item--section {
            margin: 0;
          }
        }
      }

      // Hack: Always show active navigation tab on breakpoint screen, despite
      // of checkbox being checked or not - see https://t.ly/Qc311
      .md-nav[data-md-level="1"] {
        grid-template-rows: minmax(#{px2rem(8px)}, 1fr);
        visibility: visible;
        opacity: 1;
      }
    }
  }
}
